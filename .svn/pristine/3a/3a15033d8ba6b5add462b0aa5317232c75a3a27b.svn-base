<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name = "format-detection" content="telephone = no" />
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>星驰达零食盒子</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <style>
	  	
	</style>
</head>
<body>
	<div id="takeOut" class="index-container">
		<div class="index-nav">
			<div class="index-back"></div>
			<div class="index-search">
				<img src="img/index-icon/index-search.png"/>
				<input v-model.trim="search" placeholder="请输入商品名称" @input="searchHandle()"/>
			</div>
			<div class="index-searchBtn" @click="searchClick()">搜索</div>
		</div>
		<div class="index-header" v-cloak>
			<div><img src="./img/boxlogo.jpg" /></div>
			<div v-text="indexData.boxAddress"></div>
		</div>
		<div class="index-main" ref="indexMain">
			<div class="index-aside-L">
				<ul>
					<li :class="{active:index==initTab}" v-for="(value,index) of indexData.cateList" v-cloak  :key="indexData.cateList.foodTypeId" @click="indexAsideTab(index)">
						<!--<img :src="imgIp + value.foodTypeImg" v-show="value.foodTypeImg != ''" />-->
						<div v-text="value.foodTypeName"></div>
					</li>
				</ul>
			</div>
			<div class="index-aside-R">
				<div class="indexDemo" v-for="(value,index) of viewDemo" v-cloak  :key="viewDemo.prodId">
					<div class="indexDemoL" @click="listClick(index)">
						<img :src="imgIp + value.logo"/>
					</div>
					<div class="indexDemoR" :class="{indexDemoRBgc: value.prodNum == '0'}">
						<div v-text="value.prodName"></div>
						<div>
							<span>库存数量：{{value.prodNum}}</span>
						</div>
						<div>
							<span class="indexPrice">{{value.petailPrice | moneyMark(value.petailPrice)}}</span>
							<p>
								<span @click.stop="subPrice(index)"></span>
								<span><input v-model="value.num" disabled="disabled" /></span>
								<span @click.stop="addPrice(index)"></span>
							</p>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="index-footer" v-cloak>
			<div>共计：<span>{{this.moneyNum | moneyMark(this.moneyNum)}}</span></div>
			<button @click="sendDataClick()" :disabled="isClick">去结算</button>
		</div>
	</div>
<script src="js/vue.js" type="text/javascript" charset="utf-8"></script>
<script src="js/element-ui@2.4.1.js" type="text/javascript" charset="utf-8"></script>
<script src="js/axios.min.js" type="text/javascript" charset="utf-8"></script>
<!--3des编码解码 js文件-->
<script src="js/tripledes.js" type="text/javascript" charset="utf-8"></script>
<script src="js/mode-ecb.js" type="text/javascript" charset="utf-8"></script>
<script src="js/encrypt.js" type="text/javascript" charset="utf-8"></script>
<!--公共js-->
<script src="js/pubilic.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8">
var vm = new Vue({  
    el : '#takeOut',
    beforeMount: function () {
	  	this.initParm();
	},
    mounted: function () {
	  	var indexMainHeight = document.documentElement.clientHeight - 179 + 'px';
	  	this.$refs.indexMain.style.height = indexMainHeight;
	  	this.setFontSize();
	},
    data : {
    	//获取商家Id
    	boxId : getParam('boxId'),
    	imgIp : respImg,
    	initTab : '0',
        search : '',
        moneyNum : 0,
        isClick : false,
        indexData : {},
        viewDemo : [],
        sendData : []
    },  
    meta:{
    	keepActive:true
    },
    methods : {
    	//初始化配置参数
    	initParm(){
    		this.startLoading();
    		//请求 获取code
    		var H5params = {
    			"funCode": "queryMenu",
    			"agentId": "1",
    			"boxId": this.boxId
    		}
//  		console.log(H5params);
    		H5params = JSON.stringify(H5params);
    		//3des数据加密
      		var initEnterData = encrypt.encryptByDES(H5params);
    		var ajaxParm = {
    			"H5params":initEnterData
			}
    		this.initResp(ajaxParm);
    	},
    	//公共请求服务
    	initResp(ajaxParm){
    		axios({
    			url: respUrl,
				method: 'post',
				data: ajaxParm,
			}).then(resp => {
				//返回数据解密
				var outData = encrypt.decryptByDES(resp.data);
				outData = JSON.parse(outData);
//				console.log(JSON.stringify(outData));
				if(outData.resultCode == '0'){
					this.indexData = outData;
					this.viewDemo = this.indexData.cateList[0].foodList;
					this.endLoading();
					this.message(outData.resultMessage,'success');
				}else{
					this.endLoading();
					this.message(outData.resultMessage,'error');
				}
			}).catch(err => {
				this.endLoading();
				this.message(err,'error');
		   	});
    	},
    	//搜索
    	searchClick(){
    		this.viewDemo = [];
    		if (this.search) {
	    		this.initTab = null;
	    		let	_that = this;
	    		_that.indexData.cateList.forEach(function(v , k) {
	    			v.foodList.forEach(function(v1 , k1) {
			          	v1.prodName.search(_that.search) != -1 && _that.viewDemo.push(v1);
			       	});
		      	});
    		} 
    	},
    	//搜索回车
    	searchHandle(){
            this.searchClick();
    	},
    	//tab切换事件
    	indexAsideTab(e){
    		this.initTab = e;
    		this.viewDemo = this.indexData.cateList[e].foodList;
    	},
    	//加
    	addPrice(e){
    		if (this.viewDemo[e].num < this.viewDemo[e].prodNum) {
    			this.viewDemo[e].num =  ++this.viewDemo[e].num;
    			this.moneyNum += this.viewDemo[e].petailPrice * 1;    			
    		} else{
    			this.message('不能超过现有库存数量'+this.viewDemo[e].prodNum+'件','error');
    		}
    	},
    	//减
    	subPrice(e){
    		if (this.viewDemo[e].num > 0) {
    			this.viewDemo[e].num =  --this.viewDemo[e].num;
    			this.moneyNum -= this.viewDemo[e].petailPrice * 1;
    		}
    	},
    	//点击列表查看详情
    	listClick(e){
    		sessionStorage.setItem('listData',JSON.stringify(this.viewDemo[e]));
    		window.location.href = "./foodDetails.html";
    	},
    	//去结算
    	sendDataClick(){
    		let	_that = this;
    		_that.indexData.cateList.forEach(function(v , k) {
    			v.foodList.forEach(function(v1 , k1) {
		          	v1.num != 0 && _that.sendData.push(v1);
		       	});
	        });
			if (_that.sendData.length != 0) {
				_that.isClick = true;
				var submitData = {
					"boxAddress" : _that.indexData.boxAddress,
					"boxId" : _that.boxId,
					"agentName" : _that.indexData.agentName,
					"agentId" : _that.indexData.agentId,
					"moneyNum" : _that.moneyNum,
					"foodList" : _that.sendData,
					"courierId" : _that.indexData.courierId,
					"courierName" : _that.indexData.courierName,
					"topPrice" : _that.indexData.topPrice
				}
				sessionStorage.setItem('submitData',JSON.stringify(submitData));
				var ua = navigator.userAgent.toLowerCase();//获取判断用的对象
    			var url1 = "./settle.html";
    			var url2 = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx768b9bb8de0ef8fa&redirect_uri=http://www.bdgaoxiao.com/snacksBox/static/snackBox/settle.html&res&response_type=code&scope=snsapi_base&state=123&connect_redirect=1#wechat_redirect"
    			window.location.href = (ua.match(/MicroMessenger/i) == 'micromessenger') ? url2 : url1;
			} else{
				_that.message('未选中食物','error');
			}
    	}
   	},
   	watch : {
   		
   	}
});
</script>
</body>
</html>